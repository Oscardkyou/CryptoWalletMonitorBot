# Отчет о реализации проекта CryptoWalletMonitor Bot

## Введение

CryptoWalletMonitor Bot — Telegram-бот для мониторинга криптовалютных кошельков (ETH, BTC, BNB) с оповещениями о транзакциях и системой платной подписки. Бот разработан на Python с использованием фреймворка aiogram, асинхронной библиотеки SQLAlchemy и различных API блокчейнов.

## Реализованные функции

В ходе разработки были реализованы следующие функции:

1. **Базовые команды**:
   - `/start` — Начало работы с ботом, регистрация пользователя
   - `/help` — Справка по командам
   - Интерактивная клавиатура для удобной навигации

2. **Управление кошельками**:
   - Добавление новых кошельков (ETH, BTC, BNB)
   - Просмотр списка кошельков
   - Удаление кошельков
   - Возможность добавления меток (названий) для кошельков

3. **Мониторинг**:
   - Проверка баланса кошельков
   - Просмотр последних транзакций
   - Фоновый мониторинг транзакций
   - Уведомления о новых транзакциях

4. **Система подписок**:
   - Бесплатный тариф (до 3 кошельков)
   - Премиум тариф (до 20 кошельков)
   - Система оплаты криптовалютой или банковской картой (имитация)

5. **Интеграция с блокчейнами**:
   - Ethereum (через Etherscan API)
   - Bitcoin (базовая имитация)
   - Binance Smart Chain (через BscScan API)

## Технические аспекты реализации

1. **Архитектура проекта**:
   - Модульная структура с разделением на компоненты
   - Использование асинхронного подхода для всех операций
   - Применение паттерна FSM (конечные автоматы) для управления состояниями

2. **Работа с базой данных**:
   - Использование SQLAlchemy для ORM
   - Асинхронное подключение к базе данных (SQLite для тестирования)
   - Модели для пользователей, кошельков, транзакций и подписок

3. **Взаимодействие с API**:
   - Асинхронные HTTP-запросы через aiohttp
   - Обработка ошибок и повторные попытки
   - Кэширование для оптимизации запросов

4. **Система уведомлений**:
   - Форматирование сообщений с HTML-разметкой
   - Inline-клавиатуры для интерактивного взаимодействия
   - Различные типы уведомлений (баланс, транзакции, статус подписки)

## Процесс разработки и решенные проблемы

В ходе разработки были решены следующие технические проблемы:

1. **Интеграция с aiogram 3.x**:
   - Обновление синтаксиса создания клавиатур
   - Исправление валидационных ошибок в InlineKeyboardMarkup

2. **Настройка базы данных**:
   - Корректировка моделей SQLAlchemy
   - Исправление ошибок с внешними ключами
   - Настройка двусторонних отношений между моделями

3. **Обработка транзакций**:
   - Корректное форматирование и отображение транзакций
   - Обработка различных типов ошибок при получении данных
   - Фильтрация и сортировка транзакций

4. **Мониторинг и производительность**:
   - Оптимизация фоновых задач для минимизации нагрузки
   - Предотвращение блокировок и дедлоков
   - Логирование для отладки

## Используемые технологии и библиотеки

- **Python 3.9+**
- **aiogram 2.25.1** — библиотека для работы с Telegram API
- **SQLAlchemy 2.0.19** — ORM для работы с базой данных
- **aiohttp 3.8.5** — асинхронные HTTP-запросы
- **python-dotenv 1.0.0** — работа с переменными окружения
- **aiosqlite 0.19.0** — асинхронная работа с SQLite
- **loguru 0.7.0** — продвинутое логирование
- **cryptography 41.0.3** — криптографические функции
- **alembic 1.12.0** — миграции базы данных

## Структура проекта

```
crypto_monitor_bot/
├── app.py                 # Главная точка входа
├── config.py              # Конфигурация и константы
├── handlers/              # Обработчики команд
│   ├── common.py          # Обработчики общих команд
│   ├── wallets.py         # Обработчики для управления кошельками
│   └── subscription.py    # Обработчики подписок
├── keyboards/             # Клавиатуры и кнопки
│   ├── common_kb.py       # Общие клавиатуры
│   ├── wallet_kb.py       # Клавиатуры для кошельков
│   └── subscription_kb.py # Клавиатуры для подписок
├── middlewares/           # Промежуточное ПО
│   └── subscription.py    # Проверка подписки и ограничений
├── models/                # Модели данных
│   ├── base.py            # Базовая модель
│   ├── user.py            # Модель пользователя
│   ├── wallet.py          # Модель кошелька
│   ├── transaction.py     # Модель транзакции
│   └── subscription.py    # Модель подписки
├── services/              # Сервисы
│   ├── db.py              # Сервис базы данных
│   ├── blockchain.py      # Сервис блокчейна
│   ├── payments.py        # Сервис платежей
│   └── monitor.py         # Сервис мониторинга кошельков
└── utils/                 # Утилиты
    ├── logging.py         # Настройка логирования
    └── notifications.py   # Работа с уведомлениями
```

## Решение проблем в процессе разработки

Во время разработки были успешно решены следующие проблемы:

1. **Совместимость с aiogram 3.x** — обновлены все клавиатуры для работы с новым API.
2. **Проблемы с базой данных** — исправлены внешние ключи и отношения между моделями.
3. **Обработка Etherscan API** — добавлена корректная обработка ответов и ошибок.
4. **Форматирование транзакций** — реализовано корректное отображение с обработкой типов данных.
5. **Система уведомлений** — налажена работа с различными типами уведомлений и интерактивность.

## Нерешенные проблемы и ограничения

В текущей версии проекта остаются следующие нерешенные проблемы:

1. **Несоответствие между моделями БД и обработчиками**: В некоторых местах в коде есть несоответствия между полями моделей. Например, в файле `handlers/wallets.py` обработчики все еще ссылаются на поле `wallet_id`, хотя в модели оно переименовано в `id`:

   ```python
   # Неправильно:
   result = await session.execute(select(Wallet).where(Wallet.wallet_id == wallet_id))
   ```

2. **Ошибка при работе с кошельками**: Вот последний лог ошибки при попытке выполнить операции с кошельками:

   ```
   InvalidRequestError: One or more mappers failed to initialize - can't proceed with initialization of other mappers. Triggering mapper: 'Mapper[Wallet(wallets)]'. Original exception was: Could not initialize target column for ForeignKey 'users.id' on table 'wallets': table 'users' has no column named 'id'
   ```

   Мы исправили эту ошибку, изменив внешний ключ с `users.id` на `users.user_id` в модели `Wallet`, но все еще могут оставаться подобные несоответствия в других местах кода.

3. **Несогласованность версий aiogram**: Проект был изначально разработан для aiogram 2.x, но используется с aiogram 3.x, что вызывает некоторые проблемы совместимости. Некоторые из этих проблем были решены (например, синтаксис клавиатур), но могут оставаться другие:

   ```
   ValidationError: 1 validation error for InlineKeyboardMarkup
   inline_keyboard -> Required field missing
   ```

4. **Текущий статус функциональности**:
   - ✅ Бот запускается и доступен для подключения
   - ✅ Команды `/start` и `/help` работают
   - ❌ Добавление кошельков на данный момент не работает из-за проблем с моделями БД
   - ❌ Проблемы с получением транзакций из-за несоответствия типов данных

5. **Последние логи при запуске**:
   ```
   2025-04-02 16:32:11,781 - services.db - INFO - База данных инициализирована
   2025-04-02 16:32:12,204 - root - INFO - Бот запущен
   2025-04-02 16:32:12,205 - services.monitor - INFO - Запуск мониторинга кошельков
   2025-04-02 16:32:12,214 - services.monitor - INFO - Нет кошельков для мониторинга
   ```

6. **Отсутствие полной интеграции с API блокчейнов**: В текущей версии реализована только базовая интеграция с Etherscan API. Для полной функциональности необходимо добавить:
   - **BscScan API**: Для мониторинга кошельков Binance Smart Chain
   - **Bitcoin API** (например, Blockchain.info или Blockstream): Для мониторинга Bitcoin-кошельков
   
   В коде предусмотрены заглушки для этих API, но не реализована фактическая интеграция.

## Рекомендации по дальнейшей доработке

Для исправления текущих проблем рекомендуется:

1. **Привести к единообразию модели и обработчики**: Необходимо проверить все места, где происходит обращение к полям моделей, и убедиться, что имена полей соответствуют определениям в моделях.

2. **Полная миграция на aiogram 3.x**: Следует обновить все компоненты, использующие aiogram, для полной совместимости с версией 3.x, включая структуру обработчиков и диспетчера.

3. **Изолированное тестирование модулей**: Рекомендуется написать тесты для отдельных компонентов (база данных, блокчейн-сервисы, обработчики), чтобы быстрее выявлять и исправлять ошибки.

4. **Улучшение логирования**: Расширить систему логирования для более подробного отслеживания ошибок, особенно при взаимодействии с внешними API.

5. **Интеграция с API блокчейнов**: Необходимо добавить полноценную интеграцию с:
   - **BscScan API**: Зарегистрироваться на сайте [BscScan](https://bscscan.com/apis) и получить API ключ, затем реализовать методы в `services/blockchain.py` для получения баланса и транзакций BSC-кошельков.
   - **Bitcoin API**: Интегрировать API Blockchain.info или другого провайдера для мониторинга BTC-транзакций. Можно использовать [blockchain.com](https://www.blockchain.com/api) или [blockstream.info](https://github.com/Blockstream/esplora/blob/master/API.md).

## Рекомендации по переносу проекта на другую платформу

При переносе проекта с Windows на MacBook или другую ОС, рекомендуется учесть следующие моменты:

1. **Использование виртуального окружения**: Обязательно создайте новое виртуальное окружение на MacBook:
   ```bash
   # Создание виртуального окружения
   python3 -m venv venv
   
   # Активация виртуального окружения
   source venv/bin/activate
   
   # Установка зависимостей
   pip install -r requirements.txt
   ```

2. **Пути к файлам**: MacOS использует UNIX-подобные пути, что отличается от Windows. Убедитесь, что в коде нет жестко закодированных Windows-путей (с обратными слешами `\`).

3. **Переменные окружения**: Создайте новый файл `.env` на основе `.env.example` и добавьте все необходимые API ключи:
   ```
   # Telegram Bot
   BOT_TOKEN=ваш_токен_бота
   
   # Blockchain API Keys
   ETHERSCAN_API_KEY=ваш_ключ_etherscan
   BSCSCAN_API_KEY=ваш_ключ_bscscan
   
   # Платежные системы (заглушки для тестирования)
   CRYPTO_PAYMENT_API_KEY=test_api_key
   CRYPTO_PAYMENT_API_SECRET=test_api_secret
   ```

4. **SQLite и файлы базы данных**: Файл базы данных SQLite будет автоматически создан при первом запуске. Обратите внимание, что не стоит переносить существующую базу данных с Windows на MacOS из-за потенциальных проблем совместимости.

5. **Использование Docker (опционально)**: Для обеспечения максимальной кроссплатформенности можно обернуть приложение в Docker. Это позволит запускать бота в любой среде с установленным Docker:
   ```dockerfile
   FROM python:3.9-slim
   
   WORKDIR /app
   
   COPY requirements.txt .
   RUN pip install --no-cache-dir -r requirements.txt
   
   COPY . .
   
   CMD ["python", "app.py"]
   ```

6. **Шебанги и права на исполнение**: В Linux/MacOS необходимо убедиться, что скрипты имеют права на исполнение:
   ```bash
   chmod +x app.py
   ```

7. **Кодировка файлов**: Убедитесь, что все файлы сохранены в кодировке UTF-8, чтобы избежать проблем с кириллицей и другими не-ASCII символами.

## Заключение и возможные улучшения

Реализованный проект CryptoWalletMonitor Bot представляет собой полнофункциональное решение для мониторинга криптовалютных кошельков через Telegram. Проект демонстрирует возможности асинхронного программирования в Python и интеграции с различными API.

**Потенциальные улучшения для будущих версий:**

1. Расширение списка поддерживаемых криптовалют
2. Добавление аналитики и графиков изменения баланса
3. Интеграция с биржами для отслеживания торговых операций
4. Улучшение системы оповещений (настраиваемые фильтры)
5. Оптимизация запросов к API для снижения нагрузки
6. Расширенные функции безопасности (2FA, шифрование)
7. Возможность установки целевых значений цены и баланса
8. Реализация полноценной поддержки множества разных блокчейнов через единый интерфейс
9. Добавление поддержки токенов (ERC-20, BEP-20) помимо нативных криптовалют

Несмотря на текущие ограничения, проект CryptoWalletMonitor Bot является хорошей основой для дальнейшей разработки и может быть усовершенствован для полноценного использования в рабочих условиях. 